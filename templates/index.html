<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <title>Flask App</title>
  </head>
  <body>
    <div class="container mt-5">
      <div class="row">
        <div class="col">
          <h1 class="text-center mb-5">Поиск контрагентов</h1>
          <input type="text" class="form-control" id="search" placeholder="Введите название контрагента">
          <div id="suggestions" class="list-group mt-3" style="display:none;"></div>
        </div>
      </div>
      <div class="row mt-5" id="results" style="display:none;">
        <div class="col">
          <button class="btn btn-primary mb-3" id="back">Вернуться к поиску</button>
          <div id="details"></div>
        </div>
      </div>
    </div>
    <script>
        $(document).ready(function() {
          function showSuggestions(data) {
            $("#suggestions").empty().show();
            $.each(data, function(index, item) {
              let suggestion = $('<a href="#" class="list-group-item list-group-item-action"></a>').text(item.name).data("item", item);
              $("#suggestions").append(suggestion);
            });
          }
    
          function hideSuggestions() {
            $("#suggestions").empty().hide();
          }
    
          $("#search").on("input", function() {
            let query = $(this).val();
            if (query.length > 1) {
              $.getJSON("/search?query=" + query, function(data) {
                if (data.length > 0) {
                  showSuggestions(data);
                } else {
                  hideSuggestions();
                }
              });
            } else {
              hideSuggestions();
            }
          });
    
          $(document).on("click", "#suggestions a", function() {
            let item = $(this).data("item");
            $("#search").val(item.name);
            hideSuggestions();
            $("#results").show();
            $("#details").empty();
            
            let contractInfoHtml = "";
        $.each(item.contractInfo, function(index, contract) {
          contractInfoHtml += `
            <div class="contract">
              <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#contract-${index}">
                Контракт ${contract.leasingContractName}
              </button>
              <div class="collapse" id="contract-${index}">
                <div class="card card-body">
                  <p>ОДЗ: ${contract.odz}</p>
                  <p>Статус контракта: ${contract.contractState}</p>
                  <p>Срок задержки: ${contract.delayTerm}</p>
                  <p>Общая задержка платежа: ${contract.wholePaymentDelay}</p>
                  <p>Название договора лизинга: ${contract.leasingContractName}</p>
                  <p>Нумерация ID договора: ${contract.leasingContractNumberingId}</p>
                  <p>Сумма задержки платежа с НДС в валюте контракта: ${contract.paymentDelaySumNdsInContractCurrency}</p>
                  <p>Остаток задолженности по контракту: ${contract.indebtednessRemainsByContract}</p>
                  <p>Логин эксперта по мониторингу: ${contract.monitoringExpertLogin}</p>
                  <p>Имя эксперта по мониторингу: ${contract.monitoringExpertName}</p>
                  <p>Срок задержки возврата ПТС: ${contract.ptsReturnDelayTerm}</p>
                </div>
          `;
        });

        let details = `
          <p>ID: ${item.id}</p>
          <p>Название: ${item.name}</p>
          <p>ИНН: ${item.inn}</p>
          <p>Статус ЕГРЮЛ: ${item.egrulStatus}</p>
          <p>ВИП: ${item.vip}</p>
          <p>Нерезидент: ${item.noResident}</p>
          <p>ID филиала: ${item.branchId}</p>
          <p>ОНЧИ: ${item.onchi}</p>
          <p>ОДЗ: ${item.odz}</p>
          ${contractInfoHtml}
        `;

        $("#details").html(details);
      });

      $("#back").on("click", function() {
        $("#results").hide();
        $("#search").val("");
      });
    });
  </script>
      
  </body>
</html>

